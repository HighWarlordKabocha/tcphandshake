<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TCP Three-Way Handshake</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background:#0f172a; color:#e2e8f0; }
    header { padding: 16px 20px; border-bottom: 1px solid rgba(226,232,240,.15); }
    main { display: grid; grid-template-columns: 1fr 1.2fr 1fr; gap: 16px; padding: 16px; }

    .panel { background:#111827; border:1px solid rgba(226,232,240,.15); border-radius: 12px; padding: 14px; }
    .panel h2 { margin: 0 0 8px; font-size: 16px; color:#93c5fd; }

    .lane { min-height: 420px; display:flex; flex-direction:column; gap: 18px; }
    .step { display:grid; grid-template-columns: 1fr 120px 1fr; align-items:center; gap: 10px; }

    .arrow {
      text-align:center;
      font-size: 18px;
      opacity: .95;
      user-select:none;
      position: relative;
      height: 34px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow: visible;
    }

    /* Track line is invisible */
    .arrow::after{
      content:"";
      position:absolute;
      left: 14px;
      right: 14px;
      top: 50%;
      height: 2px;
      transform: translateY(-50%);
      background: transparent;
      pointer-events:none;
    }

    .packet {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 950;
      font-size: 12px;
      letter-spacing: .3px;
      border: 1px solid rgba(226,232,240,.18);
      background: rgba(148,163,184,.12);
      opacity: 0;
      pointer-events:none;
      white-space: nowrap;
    }
    .packet.ok {
      border-color: rgba(34,197,94,.55);
      background: rgba(34,197,94,.14);
      color: #bbf7d0;
    }
    .packet.no {
      border-color: rgba(239,68,68,.55);
      background: rgba(239,68,68,.14);
      color: #fecaca;
    }

    @keyframes moveLTR {
      0%   { left: 14px; opacity: 0; }
      10%  { opacity: 1; }
      90%  { opacity: 1; }
      100% { left: calc(100% - 14px); opacity: 0; }
    }
    @keyframes moveRTL {
      0%   { left: calc(100% - 14px); opacity: 0; }
      10%  { opacity: 1; }
      90%  { opacity: 1; }
      100% { left: 14px; opacity: 0; }
    }

    .pillRow {
      grid-column: 1 / -1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      padding: 10px 0;
      border-radius: 12px;
      background: rgba(148,163,184,.06);
      border: 1px solid rgba(226,232,240,.12);
    }

    .slotPill {
      min-width: 110px;
      min-height: 42px;
      background: rgba(148,163,184,.08);
      border: 1px dashed rgba(226,232,240,.35);
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(226,232,240,.65);
      padding: 4px 12px;
      font-weight: 700;
      user-select:none;
      transition: all .15s ease;
    }

    .slotPill.filled {
      border-style: solid;
      border-color: rgba(226,232,240,.55);
      background: rgba(148,163,184,.14);
      color: #e2e8f0;
    }

    .slotPill.good { border-color: rgba(34,197,94,.6); background: rgba(34,197,94,.12); color:#bbf7d0; }
    .slotPill.bad  { border-color: rgba(239,68,68,.7); background: rgba(239,68,68,.12); color:#fecaca; }

    .hyphen { opacity:.7; font-weight:900; }

    .tray { display:flex; flex-wrap:wrap; gap: 10px; margin-top: 10px; }
    .card {
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(226,232,240,.18);
      background: rgba(59,130,246,.18);
      cursor: grab;
      user-select:none;
      font-weight: 800;
      letter-spacing: .3px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .card:active { cursor: grabbing; }
    .card.disabled { opacity: .45; cursor: not-allowed; }

    .controls { display:flex; gap: 10px; margin-top: 10px; }
    button {
      border: 1px solid rgba(226,232,240,.2);
      background: rgba(226,232,240,.08);
      color:#e2e8f0;
      padding: 10px 12px;
      border-radius: 10px;
      cursor:pointer;
      font-weight: 700;
    }
    button:hover { background: rgba(226,232,240,.12); }
    button:disabled { opacity:.5; cursor:not-allowed; }

    .hint { font-size: 13px; opacity:.85; margin-top: 8px; line-height: 1.35; }
    .hint h3 { margin: 10px 0 4px; font-size: 14px; color:#cbd5e1; }
    .muted { opacity:.75; }

    /* Server status + lesson card styling (right panel) */
    .infoCard {
      margin-top: 12px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(226,232,240,.15);
      background: rgba(148,163,184,.06);
    }

    .stateLine {
      font-weight: 900;
      letter-spacing: .3px;
      display:flex;
      gap: 8px;
      align-items: baseline;
      flex-wrap: wrap;
    }
    .stateLabel { opacity: .8; font-weight: 800; }
    .stateValue { font-weight: 950; }
    .stateValue.listen { color:#93c5fd; }
    .stateValue.established { color:#86efac; }

    /* Lesson card (hidden until established) */
    #lessonCard { display: none; }
    #lessonCard .lessonTitle {
      font-weight: 950;
      color: #cbd5e1;
      margin-bottom: 8px;
      letter-spacing: .2px;
    }
    #lessonCard .lessonBody {
      font-size: 13px;
      opacity: .9;
      line-height: 1.45;
    }
    #lessonCard ul {
      margin: 8px 0 8px 18px;
      padding: 0;
    }
    #lessonCard li { margin: 4px 0; }

    /* Flag appears at bottom of lesson card */
    #lessonFlag {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(226,232,240,.12);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      font-weight: 900;
      display: none;
      word-break: break-word;
      color: #bbf7d0;
    }

    @media (max-width: 1050px) {
      main { grid-template-columns: 1fr; }
      .lane { min-height: auto; }
    }
  </style>
</head>
<body>
<header>
  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
    <div>
      <div style="font-weight:900; font-size:18px;">TCP Three-Way Handshake</div>
      <div class="muted" style="font-size:13px;">Drag the TCP flag cards into the lane to form a valid handshake.</div>
    </div>
  </div>
</header>

<main>
  <!-- LEFT PANEL -->
  <section class="panel">
    <h2>TCP Connections</h2>
    <div class="hint">
      <h3>TCP Connections</h3>
      TCP is a communication method that computers use to reliably send data over a network.
      Before data can be sent, a connection must first be established.

      <h3>The TCP Three-Way Handshake</h3>
      To start a connection, TCP uses a process called the three-way handshake.
      This is a short exchange of packets between a client and a server that confirms both sides are ready to communicate.
      Each packet contains special control flags that describe its purpose.

      <h3>Your Challenge</h3>
      Your task is to complete the three-way handshake by dragging and dropping the correct control flag cards into each step.
      Arrange the cards so the connection is properly established.

      <h3>Check Your Work</h3>
      Click <b>Check</b> to watch the handshake play.
      Click <b>Reset</b> to try again.
    </div>

    <div class="controls">
      <button id="checkBtn">Check</button>
      <button id="resetBtn">Reset</button>
    </div>
  </section>

  <!-- HANDSHAKE LANE -->
  <section class="panel lane">
    <h2>Three-Way Handshake</h2>

    <!-- Step 1 -->
    <div class="step">
      <div style="text-align:right; opacity:.85;">Client</div>
      <div class="arrow">
        →
        <div class="packet" id="pkt1"></div>
      </div>
      <div style="opacity:.85;">Server</div>

      <div class="pillRow">
        <div class="slotPill" data-accept="SYN">Drop</div>
      </div>
    </div>

    <!-- Step 2 -->
    <div class="step">
      <div style="text-align:right; opacity:.85;">Client</div>
      <div class="arrow">
        ←
        <div class="packet" id="pkt2"></div>
      </div>
      <div style="opacity:.85;">Server</div>

      <div class="pillRow">
        <div class="slotPill" data-accept="SYN">Drop</div>
        <div class="hyphen">-</div>
        <div class="slotPill" data-accept="ACK">Drop</div>
      </div>
    </div>

    <!-- Step 3 -->
    <div class="step">
      <div style="text-align:right; opacity:.85;">Client</div>
      <div class="arrow">
        →
        <div class="packet" id="pkt3"></div>
      </div>
      <div style="opacity:.85;">Server</div>

      <div class="pillRow">
        <div class="slotPill" data-accept="ACK">Drop</div>
      </div>
    </div>
  </section>

  <!-- CARDS + STATUS + LESSON -->
  <section class="panel">
    <h2>Cards</h2>
    <div class="hint muted">Some cards are used more than once.</div>

    <div class="tray">
      <div class="card" draggable="true" data-msg="SYN" title="Synchronize">SYN</div>
      <div class="card" draggable="true" data-msg="ACK" title="Acknowledge">ACK</div>
      <div class="card" draggable="true" data-msg="RST" title="Reset">RST</div>
      <div class="card" draggable="true" data-msg="FIN" title="Finish">FIN</div>
    </div>

    <!-- Server Status -->
    <div class="infoCard" aria-live="polite">
      <div class="stateLine">
        <span class="stateLabel">Server Status:</span>
        <span id="serverState" class="stateValue listen">LISTEN</span>
      </div>
    </div>

    <!-- Lesson Card (shown only when established) -->
    <div id="lessonCard" class="infoCard">
      <div class="lessonTitle">Lesson: What Just Happened?</div>
      <div class="lessonBody">
        <div style="font-weight:950; margin-bottom:6px;">Handshake complete.</div>
        <ul>
          <li><b>SYN:</b> Client asks to start a connection.</li>
          <li><b>SYN-ACK:</b> Server agrees and responds.</li>
          <li><b>ACK:</b> Client confirms the server’s response.</li>
        </ul>
        <div>
          The handshake makes sure both computers are ready before real data starts moving.
          That helps TCP be reliable.
        </div>

        <!-- change this placeholder text to the flag for the competition AND DELETE THIS COMMENT -->
        <div id="lessonFlag">&lt;insert flag here&gt;</div>
      </div>
    </div>
  </section>
</main>

<script>
  const cards = [...document.querySelectorAll(".card")];
  const slots = [...document.querySelectorAll(".slotPill")];

  const checkBtn = document.getElementById("checkBtn");
  const resetBtn = document.getElementById("resetBtn");

  // Server status + lesson elements (in the Cards panel)
  const serverStateEl = document.getElementById("serverState");
  const lessonCardEl = document.getElementById("lessonCard");
  const lessonFlagEl = document.getElementById("lessonFlag");

  // Packet elements
  const pkt1 = document.getElementById("pkt1");
  const pkt2 = document.getElementById("pkt2");
  const pkt3 = document.getElementById("pkt3");

  let animating = false;

  function setServerState(state) {
    serverStateEl.textContent = state;

    serverStateEl.classList.remove("listen", "established");
    if (state === "ESTABLISHED") {
      serverStateEl.classList.add("established");
      lessonCardEl.style.display = "block";
      lessonFlagEl.style.display = "block";
    } else {
      serverStateEl.classList.add("listen");
      lessonCardEl.style.display = "none";
      lessonFlagEl.style.display = "none";
    }
  }

  function setInteractivity(enabled) {
    checkBtn.disabled = !enabled;
    resetBtn.disabled = !enabled;

    cards.forEach(c => {
      c.draggable = enabled;
      c.classList.toggle("disabled", !enabled);
    });

    slots.forEach(s => {
      s.style.pointerEvents = enabled ? "auto" : "none";
      s.style.opacity = enabled ? "1" : ".85";
    });
  }

  cards.forEach(card => {
    card.addEventListener("dragstart", (e) => {
      if (animating) return;
      e.dataTransfer.setData("text/plain", JSON.stringify({ msg: card.dataset.msg }));
    });
  });

  function getDragPayload(e) {
    try { return JSON.parse(e.dataTransfer.getData("text/plain")); }
    catch { return null; }
  }

  function allowDrop(el) {
    el.addEventListener("dragover", (e) => {
      if (animating) return;
      e.preventDefault();
    });
  }

  function validateSlot(slot) {
    const accept = slot.dataset.accept;
    const got = slot.dataset.filledMsg;

    slot.classList.remove("good", "bad");
    if (!got) return false;

    if (got === accept) { slot.classList.add("good"); return true; }
    slot.classList.add("bad");
    return false;
  }

  // What the user actually placed
  function getStep1Msg() { return slots[0]?.dataset.filledMsg || null; }
  function getStep2Msgs() {
    return {
      left: slots[1]?.dataset.filledMsg || null,
      right: slots[2]?.dataset.filledMsg || null
    };
  }
  function getStep3Msg() { return slots[3]?.dataset.filledMsg || null; }

  // Correctness per step (used for early-stop)
  function step1Ok() {
    const s1 = slots[0];
    return !!s1?.dataset.filledMsg && s1.dataset.filledMsg === s1.dataset.accept;
  }
  function step2Ok() {
    const s2a = slots[1];
    const s2b = slots[2];
    const okA = !!s2a?.dataset.filledMsg && s2a.dataset.filledMsg === s2a.dataset.accept;
    const okB = !!s2b?.dataset.filledMsg && s2b.dataset.filledMsg === s2b.dataset.accept;
    return okA && okB;
  }
  function step3Ok() {
    const s3 = slots[3];
    return !!s3?.dataset.filledMsg && s3.dataset.filledMsg === s3.dataset.accept;
  }

  // Only validate (color) slots up to the step we actually reached
  function validateThroughStep(stepNum) {
    const indices = stepNum === 1 ? [0] : stepNum === 2 ? [0,1,2] : [0,1,2,3];
    indices.forEach(i => {
      const s = slots[i];
      if (s && s.dataset.filledMsg) validateSlot(s);
    });
  }

  slots.forEach(slot => {
    allowDrop(slot);

    slot.addEventListener("drop", (e) => {
      if (animating) return;
      e.preventDefault();
      const payload = getDragPayload(e);
      if (!payload || !payload.msg) return;

      slot.dataset.filledMsg = payload.msg;
      slot.textContent = payload.msg;

      slot.classList.add("filled");
      slot.classList.remove("good", "bad");

      // Any edit returns to LISTEN and hides lesson/flag
      setServerState("LISTEN");
    });
  });

  function clearPackets() {
    [pkt1, pkt2, pkt3].forEach(p => {
      p.textContent = "";
      p.style.animation = "none";
      void p.offsetWidth;
      p.classList.remove("ok", "no");
    });
  }

  function playPacket(packetEl, direction, isOk, label, delayMs) {
    return new Promise((resolve) => {
      setTimeout(() => {
        packetEl.textContent = label;
        packetEl.classList.add(isOk ? "ok" : "no");
        packetEl.style.animation = `${direction === "rtl" ? "moveRTL" : "moveLTR"} 900ms ease-in-out 1`;
        packetEl.addEventListener("animationend", () => resolve(), { once: true });
      }, delayMs);
    });
  }

  async function playHandshakeWithEarlyStop(s1OK, s2OK, s3OK, labels) {
    animating = true;
    setInteractivity(false);
    clearPackets();

    setServerState("LISTEN");

    // Step 1
    await playPacket(pkt1, "ltr", s1OK, labels.step1 || "?", 0);
    validateThroughStep(1);
    if (!s1OK) { animating = false; setInteractivity(true); return; }

    // Step 2
    await playPacket(pkt2, "rtl", s2OK, labels.step2 || "?", 120);
    validateThroughStep(2);
    if (!s2OK) { animating = false; setInteractivity(true); return; }

    // Step 3
    await playPacket(pkt3, "ltr", s3OK, labels.step3 || "?", 120);
    validateThroughStep(3);

    if (s1OK && s2OK && s3OK) setServerState("ESTABLISHED");
    else setServerState("LISTEN");

    animating = false;
    setInteractivity(true);
  }

  async function checkAll() {
    if (animating) return;

    // Don't pre-validate everything (prevents tipping off future steps).
    const s1OK = step1Ok();
    const s2OK = step2Ok();
    const s3OK = step3Ok();

    const s1Msg = getStep1Msg();
    const s2 = getStep2Msgs();
    const s3Msg = getStep3Msg();

    const labels = {
      step1: s1Msg ?? "?",
      step2: (s2.left && s2.right) ? `${s2.left}-${s2.right}` : "?",
      step3: s3Msg ?? "?"
    };

    await playHandshakeWithEarlyStop(s1OK, s2OK, s3OK, labels);
  }

  function resetAll() {
    if (animating) return;

    slots.forEach(slot => {
      slot.classList.remove("good", "bad", "filled");
      delete slot.dataset.filledMsg;
      slot.textContent = "Drop";
    });

    clearPackets();
    setServerState("LISTEN");
  }

  checkBtn.addEventListener("click", checkAll);
  resetBtn.addEventListener("click", resetAll);

  resetAll();
</script>
</body>
</html>
